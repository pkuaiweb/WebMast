

### 新架构图

```
┌─────────────────────────────────────────────────────────────────────────┐
│                            Chrome Extension                              │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                          │
│  ┌──────────────┐                    ┌─────────────────────────────┐   │
│  │   Popup      │                    │    Content Script           │   │
│  │   (UI层)      │                    │    (DOM 访问)                │   │
│  │              │                    │                             │   │
│  │  • 用户输入   │                    │  • 提取页面内容               │   │
│  │  • 显示结果   │                    │  • 发送给 Background          │   │
│  └──────┬───────┘                    └─────────────┬───────────────┘   │
│         │                                          │                    │
│         │  Port: chat_stream                       │ sendMessage        │
│         │  (streaming)                             │                    │
│         ▼                                          ▼                    │
│  ┌──────────────────────────────────────────────────────────────────┐  │
│  │                  Background Service Worker                        │  │
│  │                      (控制平面)                                    │  │
│  │                                                                   │  │
│  │  • 请求路由 & 权限校验                                              │  │
│  │  • 任务队列管理                                                    │  │
│  │  • 创建/唤醒 Offscreen Document                                   │  │
│  │  • 会话管理 (session)                                              │  │
│  │  • 摘要缓存管理                                                    │  │
│  │  • Streaming 端口转发                                              │  │
│  └───────────────────────────────┬──────────────────────────────────┘  │
│                                  │                                      │
│                                  │ sendMessage                          │
│                                  ▼                                      │
│  ┌──────────────────────────────────────────────────────────────────┐  │
│  │                     Offscreen Document                            │  │
│  │                        (推理平面)                                  │  │
│  │                                                                   │  │
│  │  • 初始化 WebGPU                                                  │  │
│  │  • 加载模型 (权重缓存、分片加载)                                     │  │
│  │  • 执行推理 (streaming token)                                      │  │
│  │  • 维护 KV cache / batch / quant 优化                              │  │
│  │  • 请求取消 (abort)                                                │  │
│  └──────────────────────────────────────────────────────────────────┘  │
│                                  │                                      │
│                                  ▼                                      │
│                            ┌──────────┐                                 │
│                            │  WebGPU  │                                 │
│                            │   GPU    │                                 │
│                            └──────────┘                                 │
└─────────────────────────────────────────────────────────────────────────┘
```

### 关键改动

| 文件 | 改动 |
|------|------|
| background.ts | 移除 `ExtensionServiceWorkerMLCEngineHandler`，改为纯控制平面 |
| offscreen.ts | 唯一的推理引擎，支持 streaming 和请求取消 |
| popup.ts | 移除 `CreateExtensionServiceWorkerMLCEngine`，通过 Port 与 background 通信 |

### 统一使用一个模型

现在只有 **一个引擎**，运行在 Offscreen Document 中：
- 模型：`Llama-3.2-1B-Instruct-q4f16_1-MLC`
- 同时处理：用户问答 + 页面摘要

Made changes.